const http=require("http"),fs=require("fs").promises,path=require("path"),PORT=3e3,PUBLIC_DIR=path.join(__dirname,"public"),ERROR_DIR=path.join(__dirname,"Error"),CACHE_MAX_ITEMS=500,CACHE_MAX_BYTES=1048576e3;class LRUCache{constructor(e,t){this.cache=new Map,this.usage=new Map,this.size=0,this.bytes=0,this.maxItems=e,this.maxBytes=t}get(e){var t=this.cache.get(e);return t?(this.usage.set(e,Date.now()),t):null}set(e,t,s){var a;if(this.cache.has(e))a=this.cache.get(e),this.bytes=this.bytes-a.byteSize+s,this.cache.set(e,{...t,byteSize:s}),this.usage.set(e,Date.now());else{for(;(this.size>=this.maxItems||this.bytes>=this.maxBytes)&&0!==this.usage.size;){var r=Array.from(this.usage.entries()).sort((e,t)=>e[1]-t[1])[0][0],i=this.cache.get(r);this.cache.delete(r),this.usage.delete(r),this.size--,this.bytes-=i.byteSize}this.cache.set(e,{...t,byteSize:s}),this.usage.set(e,Date.now()),this.size++,this.bytes+=s}}}const fileCache=new LRUCache(CACHE_MAX_ITEMS,CACHE_MAX_BYTES),errorPages=new Map,contentTypeMap=new Map([[".html","text/html; charset=utf-8"],[".css","text/css"],[".js","text/javascript"],[".json","application/json"],[".png","image/png"],[".jpg","image/jpeg"],[".jpeg","image/jpeg"],[".gif","image/gif"],[".ico","image/x-icon"],[".svg","image/svg+xml"]]);function getContentType(e){e=path.extname(e).toLowerCase();return contentTypeMap.get(e)||"application/octet-stream"}async function loadErrorPages(){try{var e=(await fs.readdir(ERROR_DIR)).map(async e=>{var t=e.match(/^(\d+)\.html$/);t&&(t=t[1],e=path.join(ERROR_DIR,e),e=await fs.readFile(e),errorPages.set(t,{content:e,contentType:"text/html; charset=utf-8"}))});await Promise.all(e)}catch(e){console.error("[ERROR] 加载错误页面失败:",e)}}async function ensureErrorPages(){var e=["400","401","403","404","500"].map(async e=>{if(!errorPages.has(e))try{var t=path.join(ERROR_DIR,e+".html"),s=await fs.readFile(t);errorPages.set(e,{content:s,contentType:"text/html; charset=utf-8"})}catch{}});await Promise.all(e)}function sendErrorResponse(e,t,s=""){var a=errorPages.get(t);a?(e.statusCode=+t,e.setHeader("Content-Type",a.contentType),e.setHeader("Cache-Control","Public, max-age=3600"),e.end(a.content)):(e.statusCode=+t,e.setHeader("Content-Type","text/plain; charset=utf-8"),e.end(t+" "+s))}function getCacheMaxAge(e){switch(path.extname(e).toLowerCase()){case".css":case".js":case".png":case".jpg":case".jpeg":case".gif":case".ico":case".svg":return 31536e3;case".html":return 86400;default:return 3600}}function shouldCache(e,t){return!(10485760<t.size)&&(t=path.extname(e).toLowerCase(),/\.(html|css|js|png|jpg|jpeg|gif|ico|svg)$/.test(t))}async function cacheFile(e){try{var t,s,a,r=await fs.stat(e);return shouldCache(e,r)?(t=fileCache.get(e))&&new Date(t.lastModified)>=new Date(r.mtime)?t:(a={content:s=await fs.readFile(e),contentType:getContentType(e),lastModified:r.mtime},fileCache.set(e,a,s.byteLength),a):{content:await fs.readFile(e),contentType:getContentType(e),lastModified:r.mtime}}catch(e){throw e}}let cacheStats={hits:0,misses:0};async function startServer(){await loadErrorPages(),await ensureErrorPages(),http.createServer(async(t,s)=>{try{let e=path.join(PUBLIC_DIR,"/"===t.url?"index.html":t.url);if(e.startsWith(PUBLIC_DIR)){try{await fs.access(e)}catch{return void sendErrorResponse(s,"404","Not Found")}if((await fs.stat(e)).isDirectory()){e=path.join(e,"index.html");try{await fs.access(e)}catch{return void sendErrorResponse(s,"404","Not Found")}}var a=await cacheFile(e),r=new Date(a.lastModified).toUTCString(),i=getCacheMaxAge(e);s.statusCode=200,s.setHeader("Last-Modified",r),s.setHeader("Cache-Control","Public, max-age="+i),s.setHeader("Content-Type",a.contentType),s.end(a.content),cacheStats.hits++}else sendErrorResponse(s,"403","Forbidden")}catch(e){console.error("[SERVER ERROR]",e.message),sendErrorResponse(s,"500","Internal Server Error"),cacheStats.misses++}}).listen(PORT,()=>{console.log("服务器运行在 http://localhost:"+PORT),console.log("静态文件目录: "+PUBLIC_DIR),console.log(`内存缓存: 最大${CACHE_MAX_ITEMS}项 / ${(CACHE_MAX_BYTES/1024/1024).toFixed(1)}MB`)}),setInterval(()=>{var e=(cacheStats.hits/(cacheStats.hits+cacheStats.misses||1)*100).toFixed(1);console.log(`[CACHE] 命中率: ${e}% | 已用: ${(fileCache.bytes/1024/1024).toFixed(1)}MB/${(CACHE_MAX_BYTES/1024/1024).toFixed(1)}MB | 项数: `+fileCache.size),cacheStats={hits:0,misses:0}},3e5)}startServer();