const http=require("http"),https=require("https"),fs=require("fs"),path=require("path"),ini=require("ini");class ConfigDrivenProxyServer{constructor(){this.server=null,this.config={},this.configPath=path.join(__dirname,"Conf","Router.ini"),this.startAttempts=new Map,this.maxAttempts=2e4,this.init()}log(e,t,r="",s=""){var o=(new Date).toLocaleTimeString("zh-CN",{hour12:!1}),i={info:"ä¿¡æ¯",error:"é”™è¯¯",warn:"è­¦å‘Š"};r?console.log(`[${o}] [${i[e]}] ${t} "${r}" `+s):console.log(`[${o}] [${i[e]}] `+t)}init(){fs.existsSync(this.configPath)||(this.log("error","é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: Conf/Router.ini"),this.log("info","è¯·ç¡®ä¿é…ç½®æ–‡ä»¶å­˜åœ¨åé‡æ–°å¯åŠ¨æœåŠ¡å™¨"),process.exit(1)),this.loadConfig(),this.setupConfigWatcher(),this.startServer(),this.setupGracefulShutdown()}loadConfig(){try{var e=fs.readFileSync(this.configPath,"utf-8");const o=ini.parse(e);if(this.config={server:{},routes:[],errors:{}},Object.keys(o).forEach(e=>{const t=o[e];var r,s;e.includes("æœåŠ¡å™¨é…ç½®")||e.toLowerCase().includes("server")?this.config.server={port:parseInt(t.port||t.ç«¯å£),domain:t.domain||t.åŸŸå,mustInDomain:"True"===(t["must in domain"]||t["å¿…é¡»åœ¨åŸŸåå†…"])}:e.includes("é”™è¯¯")||e.toLowerCase().includes("error")?Object.keys(t).forEach(e=>{this.config.errors[e]=t[e]}):(t.From||t.FROM||t.from)&&(s=t.From||t.FROM||t.from,r=t.TO||t.To||t.to,s)&&r&&(s=s.match(/(?:Port|port|ç«¯å£):(\d+)/i))&&(e={name:e,port:parseInt(s[1]),path:r,priority:"/"===r?999:r.split("/").length},this.config.routes.push(e))}),!this.config.server.port)throw new Error("é…ç½®æ–‡ä»¶ä¸­æœªæ‰¾åˆ°ç«¯å£é…ç½®ï¼Œè¯·æ£€æŸ¥ [æœ¬æœåŠ¡å™¨é…ç½®] æ®µæ˜¯å¦åŒ…å« port = ç«¯å£å·");if(0===this.config.routes.length)throw new Error("é…ç½®æ–‡ä»¶ä¸­æœªæ‰¾åˆ°ä»»ä½•è·¯ç”±é…ç½®ï¼Œè¯·æ£€æŸ¥è·¯ç”±æ®µæ˜¯å¦åŒ…å« From = Port:ç«¯å£å· å’Œ TO = è·¯å¾„");this.config.routes.sort((e,t)=>e.priority-t.priority)}catch(e){this.log("error","é…ç½®æ–‡ä»¶è§£æå¤±è´¥: "+e.message),this.log("info","è¯·æ£€æŸ¥é…ç½®æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®"),process.exit(1)}}setupConfigWatcher(){fs.watchFile(this.configPath,{interval:1e3},(e,t)=>{if(e.mtime!==t.mtime)try{this.reload()}catch(e){this.log("error","é‡æ–°åŠ è½½å¤±è´¥: "+e.message)}})}proxyRequest(r,o,i,n,h){return new Promise(s=>{var e=new URL("http://localhost:"+i+n),e={hostname:e.hostname,port:e.port,path:e.pathname+e.search,method:r.method,headers:{...r.headers}};delete e.headers.host;const t=http.request(e,e=>{o.writeHead(e.statusCode,e.headers),e.pipe(o),s()});t.on("error",e=>{this.log("error",`ä»£ç†é”™è¯¯ [${h}]: `+e.message);let t="Server Down",r=500;"ECONNREFUSED"===e.code||"ENOTFOUND"===e.code?(t="Server Down",r=502):"ETIMEDOUT"!==e.code&&"ESOCKETTIMEDOUT"!==e.code||(t="Time Out",r=504),this.serveErrorPage(o,t,r),s()}),t.setTimeout(3e4,()=>{t.destroy(),this.serveErrorPage(o,"Time Out",504),s()}),"GET"!==r.method&&"HEAD"!==r.method?r.pipe(t):t.end()})}startServer(){this.config.routes.forEach(e=>{this.startAttempts.has(e.name)||this.startAttempts.set(e.name,0)}),this.server=http.createServer(async(e,t)=>{var r,s=new URL(e.url,"http://"+e.headers.host),o=e.headers.host;if(this.config.server.mustInDomain&&this.config.server.domain&&o&&!o.includes(this.config.server.domain))t.writeHead(403,{"Content-Type":"application/json"}),t.end(JSON.stringify({error:"Access Denied",message:"must in domain",allowedDomain:this.config.server.domain}));else{for(const i of this.config.routes)if("/"===i.path||s.pathname.startsWith(i.path))return r=("/"===i.path?s.pathname:s.pathname.replace(new RegExp("^"+i.path.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")),""))+(s.search||""),void await this.proxyRequest(e,t,i.port,r,i.name);this.serveErrorPage(t,"404",404)}}),this.server.listen(this.config.server.port,this.config.server.host||"localhost",()=>{this.log("info","ä»£ç†æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!"),this.log("info","ç›‘å¬ç«¯å£: "+this.config.server.port),this.config.server.domain&&this.log("info","åŸŸå: "+this.config.server.domain),this.log("info","â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"),this.config.routes.forEach(e=>{this.log("info",`è·¯ç”±: ${e.path} â†’ localhost:`+e.port)}),this.log("info","â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");var e=this.config.routes.length;this.log("info",`æˆåŠŸé…ç½® ${e} ä¸ªè·¯ç”±`)}),this.server.on("error",e=>{this.log("error","æœåŠ¡å™¨å¯åŠ¨å¤±è´¥: "+e.message),process.exit(1)})}serveErrorPage(e,t,r){var s=this.config.errors[t];if(s){s=path.resolve(__dirname,s);if(fs.existsSync(s))try{var o=fs.readFileSync(s,"utf-8");return e.writeHead(r,{"Content-Type":"text/html; charset=utf-8"}),void e.end(o)}catch(e){this.log("error","è¯»å–é”™è¯¯é¡µé¢å¤±è´¥: "+e.message)}}e.writeHead(r,{"Content-Type":"application/json"}),e.end(JSON.stringify({error:t,message:`é”™è¯¯ ${r}: `+t,timestamp:(new Date).toISOString()}))}setupGracefulShutdown(){var e=()=>{this.server?this.server.close(()=>{process.exit(0)}):process.exit(0)};process.on("SIGINT",e),process.on("SIGTERM",e)}reload(){this.loadConfig(),this.server?this.server.close(()=>{this.startServer()}):this.startServer()}}console.log("ğŸŒŸ å¯åŠ¨é…ç½®é©±åŠ¨çš„ä»£ç†æœåŠ¡å™¨..."),new ConfigDrivenProxyServer;