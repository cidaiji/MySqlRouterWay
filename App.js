let fork=require("child_process").fork;const fs=require("fs"),path=require("path"),ini=require("ini"),readline=require("readline");let isShuttingDown=!1;const childProcesses=new Map,crashRecovery=new Map;let startTime=Date.now();const colors={reset:"[0m",bright:"[1m",dim:"[2m",red:"[31m",green:"[32m",yellow:"[33m",blue:"[34m",magenta:"[35m",cyan:"[36m",white:"[37m"},rl=readline.createInterface({input:process.stdin,output:process.stdout});class Logger{static log(e,o="INFO"){var r=(new Date).toLocaleTimeString();console.log(`[${r}] [${o}] `+e)}static error(e){var o=(new Date).toLocaleTimeString();console.error(colors.red+`[${o}] [ERROR] `+e+colors.reset)}static success(e){var o=(new Date).toLocaleTimeString();console.log(colors.green+`[${o}] [SUCCESS] `+e+colors.reset)}static warning(e){var o=(new Date).toLocaleTimeString();console.log(colors.yellow+`[${o}] [WARNING] `+e+colors.reset)}static info(e){var o=(new Date).toLocaleTimeString();console.log(colors.cyan+`[${o}] [INFO] `+e+colors.reset)}static serviceLog(e,o,r="INFO"){var s=(new Date).toLocaleTimeString(),r={INFO:colors.cyan,SUCCESS:colors.green,WARNING:colors.yellow,ERROR:colors.red}[r]||colors.white;console.log(r+`[${s}] [${e}] `+o+colors.reset)}}class AppUtils{static printLogo(){return new Promise((r,s)=>{var e=path.join(__dirname,"StartMap/Logo/StartLogo.txt");fs.readFile(e,"utf8",(e,o)=>{if(e)Logger.error("æ— æ³•è¯»å–Logoæ–‡ä»¶: "+e.message),s(e);else{e=o.split("\n").map(e=>"[34m"+e+"[0m").join("\n");console.log(e),r()}})})}static readConfig(){var e=path.join(__dirname,"Conf/Start.ini");try{var o=ini.parse(fs.readFileSync(e,"utf-8"));if(Object.keys(o).some(e=>"all"===e.toLowerCase()))throw new Error('ä¸å…è®¸æœ‰ç¨‹åºåç§°ä¸º "ALL" æˆ– "all"');var r,s,t=[];for([r,s]of Object.entries(o)){var c=parseInt(s["priority level"])||0,l="true"===(s.Keep||s.keep||"false").toLowerCase(),i="true"===(s.ForceKeep||s.forceKeep||"false").toLowerCase();t.push({name:r,config:s,priority:c,keepAlive:l,forceKeepAlive:i})}return t.sort((e,o)=>o.priority-e.priority),t}catch(e){throw Logger.error("æ— æ³•è¯»å–é…ç½®æ–‡ä»¶: "+e.message),e}}static countdown(r){return new Promise(e=>{Logger.log(`ç³»ç»Ÿå°†åœ¨ ${r} ç§’åå¯åŠ¨...`,"WARNING");const o=setInterval(()=>{0<--r?Logger.log(`å€’è®¡æ—¶: ${r} ç§’`,"WARNING"):(clearInterval(o),Logger.success("å¼€å§‹å¯åŠ¨æœåŠ¡..."),e())},1e3)})}static formatUptime(e){var e=Math.floor(e/1e3),o=Math.floor(e/60),r=Math.floor(o/60),s=Math.floor(r/24);return 0<s?s+`å¤© ${r%24}å°æ—¶ ${o%60}åˆ†é’Ÿ ${e%60}ç§’`:0<r?r+`å°æ—¶ ${o%60}åˆ†é’Ÿ ${e%60}ç§’`:0<o?o+`åˆ†é’Ÿ ${e%60}ç§’`:e+"ç§’"}}class CommandHandler{constructor(e){this.serviceManager=e,this.setupCommands()}setupCommands(){console.log(colors.green+"\n==========================================="),console.log("    æœåŠ¡ç®¡ç†å™¨æ§åˆ¶å° - å¯ç”¨å‘½ä»¤:"),console.log("    help - æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"),console.log("    list - æ˜¾ç¤ºæ‰€æœ‰æœåŠ¡çŠ¶æ€"),console.log("    status - æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€"),console.log("    start <æœåŠ¡å> - å¯åŠ¨æŒ‡å®šæœåŠ¡"),console.log("    stop <æœåŠ¡å|all> - åœæ­¢æœåŠ¡"),console.log("    restart <æœåŠ¡å|all> - é‡å¯æœåŠ¡"),console.log("    logs <æœåŠ¡å> - æ˜¾ç¤ºæœåŠ¡æ—¥å¿—"),console.log("    crash - æ˜¾ç¤ºå´©æºƒç»Ÿè®¡"),console.log("    exit - é€€å‡ºç³»ç»Ÿ"),console.log("==========================================="+colors.reset),rl.prompt(),rl.on("line",e=>{this.processCommand(e.trim()),rl.prompt()}),rl.on("close",()=>{Logger.info("æ§åˆ¶å°ä¼šè¯ç»“æŸ"),this.serviceManager.shutdown("CONSOLE_EXIT")})}processCommand(e){var e=e.split(" "),o=e[0].toLowerCase(),r=e.slice(1);try{switch(o){case"help":case"h":this.showHelp();break;case"list":case"ls":this.listServices();break;case"status":case"stat":this.showStatus();break;case"start":0===r.length?Logger.error("è¯·æŒ‡å®šè¦å¯åŠ¨çš„æœåŠ¡åç§°"):this.startService(r[0]);break;case"stop":0===r.length?Logger.error("è¯·æŒ‡å®šè¦åœæ­¢çš„æœåŠ¡åç§°æˆ– 'all'"):this.stopService(r[0]);break;case"restart":0===r.length?Logger.error("è¯·æŒ‡å®šè¦é‡å¯çš„æœåŠ¡åç§°æˆ– 'all'"):this.restartService(r[0]);break;case"logs":0===r.length?Logger.error("è¯·æŒ‡å®šè¦æŸ¥çœ‹æ—¥å¿—çš„æœåŠ¡åç§°"):this.showLogs(r[0]);break;case"crash":this.showCrashStats();break;case"exit":case"quit":case"q":Logger.info("æ­£åœ¨é€€å‡ºç³»ç»Ÿ..."),this.serviceManager.shutdown("USER_EXIT");break;case"clear":case"cls":console.clear();break;case"":break;default:Logger.error(`æœªçŸ¥å‘½ä»¤: ${o}. è¾“å…¥ 'help' æŸ¥çœ‹å¯ç”¨å‘½ä»¤`)}}catch(e){Logger.error("å‘½ä»¤æ‰§è¡Œå¤±è´¥: "+e.message)}}showHelp(){console.log(colors.cyan+"\nğŸ“‹ å¯ç”¨å‘½ä»¤åˆ—è¡¨:"),console.log("  help, h          - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"),console.log("  list, ls         - æ˜¾ç¤ºæ‰€æœ‰æœåŠ¡çŠ¶æ€"),console.log("  status, stat     - æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€ä¿¡æ¯"),console.log("  start <æœåŠ¡å>    - å¯åŠ¨æŒ‡å®šæœåŠ¡"),console.log("  stop <æœåŠ¡å|all> - åœæ­¢æŒ‡å®šæœåŠ¡æˆ–æ‰€æœ‰æœåŠ¡"),console.log("  restart <æœåŠ¡å|all> - é‡å¯æŒ‡å®šæœåŠ¡æˆ–æ‰€æœ‰æœåŠ¡"),console.log("  logs <æœåŠ¡å>     - æ˜¾ç¤ºæŒ‡å®šæœåŠ¡çš„æ—¥å¿—ä¿¡æ¯"),console.log("  crash            - æ˜¾ç¤ºå´©æºƒç»Ÿè®¡ä¿¡æ¯"),console.log("  clear, cls       - æ¸…å±"),console.log("  exit, quit, q    - é€€å‡ºç³»ç»Ÿ"+colors.reset)}listServices(){0===childProcesses.size?Logger.info("å½“å‰æ²¡æœ‰è¿è¡Œçš„æœåŠ¡"):(console.log(colors.green+"\nğŸ“‹ æœåŠ¡åˆ—è¡¨:"),console.log("="+"=".repeat(80)),childProcesses.forEach((e,o)=>{var r=crashRecovery.get(o)||{crashes:0,recoveryAttempts:0},s=e.forceKeepAlive?"å¼ºåŠ›å®ˆæŠ¤":e.keepAlive?"æ ‡å‡†å®ˆæŠ¤":"æ— å®ˆæŠ¤",t=e.process.killed?"å·²åœæ­¢":"è¿è¡Œä¸­",c=e.process.killed?colors.red:colors.green;console.log(colors.cyan+"ğŸ”§ æœåŠ¡å: "+colors.white+o),console.log("   çŠ¶æ€: "+c+t+colors.reset),console.log("   PID: "+(e.process.pid||"N/A")),console.log("   ä¼˜å…ˆçº§: "+(e.priority||0)),console.log("   å®ˆæŠ¤æ¨¡å¼: "+s),console.log("   å´©æºƒæ¬¡æ•°: "+r.crashes),console.log("   æ¢å¤å°è¯•: "+r.recoveryAttempts),console.log("-"+"-".repeat(40))}),console.log(colors.reset))}showStatus(){var e=Date.now()-startTime,o=Math.round(process.memoryUsage().rss/1024/1024);console.log(colors.green+"\nğŸ“Š ç³»ç»ŸçŠ¶æ€:"),console.log("="+"=".repeat(50)),console.log("  ğŸ• å¯åŠ¨æ—¶é—´: "+new Date(startTime).toLocaleString()),console.log("  â±ï¸  è¿è¡Œæ—¶é•¿: "+AppUtils.formatUptime(e)),console.log("  ğŸ“‹ æ€»æœåŠ¡æ•°: "+this.serviceManager.services.length),console.log("  âœ… è¿è¡ŒæœåŠ¡: "+childProcesses.size),console.log(`  ğŸ’¾ å†…å­˜ä½¿ç”¨: ${o}MB`),console.log("  ğŸ”§ Nodeç‰ˆæœ¬: "+process.version),console.log("="+"=".repeat(50)+colors.reset)}startService(o){if(childProcesses.has(o))Logger.warning(`æœåŠ¡ "${o}" å·²åœ¨è¿è¡Œä¸­`);else{var e=this.serviceManager.services.find(e=>e.name===o);if(e)try{this.serviceManager.startService(e),Logger.success(`æœåŠ¡ "${o}" å¯åŠ¨è¯·æ±‚å·²å‘é€`)}catch(e){Logger.error(`å¯åŠ¨æœåŠ¡ "${o}" å¤±è´¥: `+e.message)}else Logger.error(`æœåŠ¡ "${o}" æœªåœ¨é…ç½®ä¸­æ‰¾åˆ°`)}}stopService(e){if("all"===e.toLowerCase())Logger.warning("æ­£åœ¨åœæ­¢æ‰€æœ‰æœåŠ¡..."),this.serviceManager.shutdown("USER_STOP_ALL");else{const o=childProcesses.get(e);o?(Logger.info("æ­£åœ¨åœæ­¢æœåŠ¡: "+e),o.process.kill("SIGINT"),setTimeout(()=>{childProcesses.has(e)&&(Logger.warning(`æœåŠ¡ ${e} æœªå“åº”ï¼Œå¼ºåˆ¶ç»ˆæ­¢`),o.process.kill("SIGKILL"))},5e3)):Logger.error(`æœåŠ¡ "${e}" ä¸å­˜åœ¨æˆ–æœªè¿è¡Œ`)}}restartService(e){"all"===e.toLowerCase()?(Logger.warning("æ­£åœ¨é‡å¯æ‰€æœ‰æœåŠ¡..."),this.serviceManager.restartAllServices()):this.serviceManager.restartSingleService(e)}showLogs(e){var o,r=childProcesses.get(e);r?(o=crashRecovery.get(e)||{crashes:0,recoveryAttempts:0,lastCrashTime:null},console.log(colors.cyan+`
ğŸ“œ æœåŠ¡ "${e}" æ—¥å¿—ä¿¡æ¯:`),console.log("="+"=".repeat(50)),console.log("  PID: "+r.process.pid),console.log("  è„šæœ¬è·¯å¾„: "+r.scriptPath),console.log("  å®ˆæŠ¤æ¨¡å¼: "+(r.forceKeepAlive?"å¼ºåŠ›å®ˆæŠ¤":r.keepAlive?"æ ‡å‡†å®ˆæŠ¤":"æ— å®ˆæŠ¤")),console.log("  å´©æºƒæ¬¡æ•°: "+o.crashes),console.log("  æ¢å¤å°è¯•: "+o.recoveryAttempts),o.lastCrashTime&&console.log("  æœ€åå´©æºƒ: "+new Date(o.lastCrashTime).toLocaleString()),console.log("="+"=".repeat(50)+colors.reset)):Logger.error(`æœåŠ¡ "${e}" ä¸å­˜åœ¨æˆ–æœªè¿è¡Œ`)}showCrashStats(){console.log(colors.yellow+"\nğŸ’¥ å´©æºƒç»Ÿè®¡ä¿¡æ¯:"),console.log("="+"=".repeat(60));let r=0,s=0,t=!1;crashRecovery.forEach((e,o)=>{(0<e.crashes||0<e.recoveryAttempts)&&(t=!0,r+=e.crashes,s+=e.recoveryAttempts,console.log(`ğŸ“‹ ${o}:`),console.log("   å´©æºƒæ¬¡æ•°: "+e.crashes),console.log("   æ¢å¤å°è¯•: "+e.recoveryAttempts),e.lastCrashTime&&console.log("   æœ€åå´©æºƒ: "+new Date(e.lastCrashTime).toLocaleString()),console.log("-"+"-".repeat(30)))}),t?console.log(`ğŸ“Š æ€»è®¡: ${r} æ¬¡å´©æºƒ, ${s} æ¬¡æ¢å¤å°è¯•`):console.log("  æš‚æ— å´©æºƒè®°å½•"),console.log("="+"=".repeat(60)+colors.reset)}}class ServiceManager{constructor(e){this.services=e}startAllServices(){Logger.info("æŒ‰ä¼˜å…ˆçº§é¡ºåºå¯åŠ¨æœåŠ¡:"),this.services.forEach(o=>{try{var e=o.forceKeepAlive?"å¼ºåŠ›å®ˆæŠ¤":o.keepAlive?"æ ‡å‡†å®ˆæŠ¤":"æ— å®ˆæŠ¤";Logger.serviceLog(o.name,`å‡†å¤‡å¯åŠ¨ (ä¼˜å…ˆçº§: ${o.priority}, å®ˆæŠ¤æ¨¡å¼: ${e})`),this.startService(o)}catch(e){Logger.serviceLog(o.name,"å¯åŠ¨å¤±è´¥: "+e.message,"ERROR")}})}startService(e){var o=e.config;if(!o.script)throw new Error("ç¼ºå°‘scripté…ç½®");var r=path.join(__dirname,o.script);if(!fs.existsSync(r))throw new Error("è„šæœ¬æ–‡ä»¶ä¸å­˜åœ¨: "+r);var o={...process.env,SERVICE_NAME:e.name,SERVICE_PRIORITY:e.priority,SERVICE_KEEP_ALIVE:e.keepAlive,SERVICE_FORCE_KEEP_ALIVE:e.forceKeepAlive,...o},s=fork(r,{env:o}),r=(crashRecovery.set(e.name,{crashes:0,lastCrashTime:null,recoveryAttempts:0}),childProcesses.set(e.name,{process:s,keepAlive:e.keepAlive,forceKeepAlive:e.forceKeepAlive,scriptPath:r,env:o,service:e,priority:e.priority}),e.forceKeepAlive?"å¼ºåŠ›å®ˆæŠ¤":e.keepAlive?"æ ‡å‡†å®ˆæŠ¤":"æ— å®ˆæŠ¤");Logger.serviceLog(e.name,`å·²å¯åŠ¨ (PID: ${s.pid}, ä¼˜å…ˆçº§: ${e.priority}, å®ˆæŠ¤: ${r})`,"SUCCESS"),this.setupChildProcessListeners(s,e)}setupChildProcessListeners(e,c){const l=c.name;e.on("message",e=>{Logger.serviceLog(l,"æ¶ˆæ¯: "+JSON.stringify(e))}),e.on("exit",(e,o)=>{const r=childProcesses.get(l),s=(childProcesses.delete(l),crashRecovery.get(l));if(s.crashes++,s.lastCrashTime=Date.now(),Logger.serviceLog(l,`å·²é€€å‡º (é€€å‡ºç : ${e}, ä¿¡å·: ${o}, å´©æºƒæ¬¡æ•°: ${s.crashes})`,"WARNING"),(r.keepAlive||r.forceKeepAlive)&&!isShuttingDown){const t=r.forceKeepAlive?"å¼ºåŠ›æ¢å¤":"æ ‡å‡†æ¢å¤";Logger.serviceLog(l,`ä½œä¸º${t}è¿›ç¨‹ï¼Œæ­£åœ¨å°è¯•é‡å¯...`);e=r.forceKeepAlive?100:5e3;s.recoveryAttempts++,setTimeout(()=>{try{const serviceToRestart={name:l,config:c.config,priority:c.priority,keepAlive:r.keepAlive,forceKeepAlive:r.forceKeepAlive};this.startService(serviceToRestart),Logger.serviceLog(l,t+`æˆåŠŸ (å°è¯•æ¬¡æ•°: ${s.recoveryAttempts})`,"SUCCESS")}catch(e){Logger.serviceLog(l,t+"å¤±è´¥: "+e.message,"ERROR"),r.forceKeepAlive&&(Logger.serviceLog(l,"å¼ºåŠ›æ¨¡å¼å°†ç»§ç»­å°è¯•é‡å¯..."),this.setupForceRecovery(serviceToRestart,s))}},e)}}),e.on("error",e=>{Logger.serviceLog(l,"é”™è¯¯: "+e.message,"ERROR")})}setupForceRecovery(r,s){const t=r.name;setTimeout(()=>{if(!isShuttingDown)try{this.startService(r),Logger.serviceLog(t,`å¼ºåŠ›æ¢å¤æœ€ç»ˆæˆåŠŸ (å°è¯•æ¬¡æ•°: ${s.recoveryAttempts})`,"SUCCESS")}catch(e){s.recoveryAttempts++,Logger.serviceLog(t,`å¼ºåŠ›æ¢å¤å°è¯• ${s.recoveryAttempts} å¤±è´¥: `+e.message,"ERROR");var o=Math.min(100*(s.recoveryAttempts+1),5e3);Logger.serviceLog(t,`å°†åœ¨ ${o}ms åå†æ¬¡å°è¯•å¼ºåŠ›æ¢å¤...`),this.setupForceRecovery(r,s)}},100*(s.recoveryAttempts+1))}restartSingleService(o){var e=childProcesses.get(o);if(e){const r=e.service;Logger.serviceLog(o,"æ­£åœ¨é‡å¯..."),e.process.kill("SIGINT"),setTimeout(()=>{try{this.startService(r),Logger.serviceLog(o,"é‡å¯æˆåŠŸ","SUCCESS")}catch(e){Logger.serviceLog(o,"é‡å¯å¤±è´¥: "+e.message,"ERROR")}},2e3)}else Logger.error(`æœåŠ¡ "${o}" ä¸å­˜åœ¨æˆ–æœªè¿è¡Œ`)}restartAllServices(){Logger.warning("æ­£åœ¨é‡å¯æ‰€æœ‰æœåŠ¡..."),childProcesses.forEach((e,o)=>{Logger.serviceLog(o,"æ­£åœ¨åœæ­¢..."),e.process.kill("SIGINT")}),setTimeout(()=>{Logger.info("é‡æ–°å¯åŠ¨æ‰€æœ‰æœåŠ¡..."),this.startAllServices()},5e3)}shutdown(e){isShuttingDown||(isShuttingDown=!0,Logger.warning(`æ”¶åˆ° ${e} ä¿¡å·ï¼Œæ­£åœ¨å…³é—­æ‰€æœ‰æœåŠ¡...`),[...childProcesses.entries()].sort((e,o)=>(e[1].priority||0)-(o[1].priority||0)).forEach(([e,o])=>{Logger.serviceLog(e,`(ä¼˜å…ˆçº§ ${o.priority||0}) æ­£åœ¨å…³é—­...`),o.process.kill("SIGINT")}),setTimeout(()=>{var e=childProcesses.size,o=(0<e&&(Logger.warning(`ä»æœ‰ ${e} ä¸ªæœåŠ¡æœªå…³é—­ï¼Œæ­£åœ¨å¼ºåˆ¶ç»ˆæ­¢...`),childProcesses.forEach(e=>e.process.kill("SIGKILL"))),Logger.info("===== æœåŠ¡å´©æºƒç»Ÿè®¡ ====="),crashRecovery.forEach((e,o)=>{(0<e.crashes||0<e.recoveryAttempts)&&Logger.serviceLog(o,`å´©æºƒ: ${e.crashes}æ¬¡, æ¢å¤å°è¯•: ${e.recoveryAttempts}æ¬¡`)}),Date.now()-startTime);Logger.info("ç³»ç»Ÿæ€»è¿è¡Œæ—¶é—´: "+AppUtils.formatUptime(o)),process.exit(0<e?1:0)},1e4))}}async function main(){try{startTime=Date.now(),await AppUtils.printLogo(),await AppUtils.countdown(3);var e=AppUtils.readConfig();const o=new ServiceManager(e);o.startAllServices(),new CommandHandler(o),process.on("SIGINT",()=>{o.shutdown("SIGINT")}),process.on("SIGTERM",()=>{o.shutdown("SIGTERM")}),process.on("SIGHUP",()=>{o.shutdown("SIGHUP")}),process.on("uncaughtException",e=>{Logger.error("æœªæ•è·çš„å¼‚å¸¸: "+e.message),console.error(e.stack),o.shutdown("uncaughtException")}),process.on("unhandledRejection",e=>{Logger.error("æœªå¤„ç†çš„Promiseæ‹’ç»: "+e),o.shutdown("unhandledRejection")})}catch(e){Logger.error("åº”ç”¨å¯åŠ¨å¤±è´¥: "+e.message),process.exit(1)}}main();