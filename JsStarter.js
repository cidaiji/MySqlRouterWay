const clear=require("clear"),fs=require("fs"),path=require("path"),readline=require("readline");let exec=require("child_process").exec;const CONFIG_FILE=path.join(__dirname,"Conf","ServerList.ini"),BASE_DIR=__dirname,serverStatus={},START_DELAY=1e4,colors={reset:"[0m",red:"[31m",green:"[32m",yellow:"[33m",blue:"[34m",magenta:"[35m",cyan:"[36m",white:"[37m",bright:"[1m",dim:"[2m"};function colorLog(e,r="white"){console.log(colors[r]+e+colors.reset)}function logMessage(e,r="info"){colorLog(`
[${(new Date).toLocaleTimeString()}] ${{error:"[é”™è¯¯]",warn:"[è­¦å‘Š]",info:"[ä¿¡æ¯]"}[r]} `+e,{error:"red",warn:"yellow",info:"cyan"}[r]||"white")}function parseIniFile(e){try{var r=fs.readFileSync(e,"utf8").split("\n");const s={servers:[],globalConfig:{}};let t=null,o=null;return r.forEach(e=>{var r;(e=e.trim())&&!e.startsWith(";")&&(e.startsWith("[")&&e.endsWith("]")?"å…¨å±€é…ç½®"===(t=e.slice(1,-1).trim()).toLowerCase()?(t="globalConfig",s[t]={},o=null):(o={name:t,type:t,scriptPath:"",config:{}},s.servers.push(o)):t&&([e,r]=e.split("=").map(e=>e.trim()),"globalConfig"===t?s.globalConfig[e]=r:o&&("way"===e.toLowerCase()||"api"===e.toLowerCase()?(o.scriptPath=r,o.type===t&&(o.type=e)):o.config[e]=r)))}),s}catch(e){return logMessage("è¯»å–é…ç½®æ–‡ä»¶å¤±è´¥: "+e.message,"error"),null}}function displayServerStatus(){clear();var e=Object.values(serverStatus).filter(e=>null!==e.pid).length,r=Object.values(serverStatus).length;colorLog(`ğŸ“Š æœåŠ¡å™¨çŠ¶æ€ [${(new Date).toLocaleTimeString()}]`,"bright"),colorLog(`   è¿è¡Œä¸­: ${e}/`+r,e===r?"green":"yellow"),console.log(),colorLog("ğŸ–¥ï¸ æœåŠ¡å™¨è¯¦æƒ…:","bright"),colorLog("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”","dim"),Object.values(serverStatus).forEach(e=>{var r=null!==e.pid,t=r?"green":"red",r=r?"ğŸŸ¢":"ğŸ”´",o=e.lastStartTime?formatUptime(Date.now()-e.lastStartTime.getTime()):"N/A";colorLog(r+` ${e.name} (${e.type})`,t),console.log(`   PID: ${e.pid||"N/A"} | è¿è¡Œæ—¶é—´: `+o),console.log(`   å®ˆæŠ¤: ${e.keepRunning?"å¯ç”¨":"ç¦ç”¨"} | é‡è¯•: ${e.currentTries}/`+e.maxTries),console.log()}),colorLog("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”","dim"),colorLog("æŒ‰ Ctrl+C æˆ– è¾“å…¥ exit ç»“æŸæœåŠ¡","yellow")}function formatUptime(e){var e=Math.floor(e/1e3),r=Math.floor(e/60),t=Math.floor(r/60),o=Math.floor(t/24);return 0<o?o+`å¤© ${t%24}æ—¶`:0<t?t+`æ—¶ ${r%60}åˆ†`:0<r?r+"åˆ†":e+"ç§’"}function startServer(e){var r,{name:e,type:t,scriptPath:o,config:s}=e;let n=o;return path.isAbsolute(n)||(n=path.join(BASE_DIR,n)),fs.existsSync(n)?(o="true"===s["keep run"],r=parseInt(s.try||"5",10),s="false"!==s["log output"],serverStatus[e]={name:e,type:t,scriptPath:n,keepRunning:o,maxTries:r,currentTries:0,pid:null,process:null,lastStartTime:null,logOutput:s,lastActivity:new Date,logs:[]},(o=restartServer(e))&&logMessage(`æœåŠ¡å™¨ "${e}" (${t}) å¯åŠ¨æˆåŠŸ (PID: ${o.pid})`),o):(logMessage(`æœåŠ¡å™¨ "${e}" (${t}) å¯åŠ¨å¤±è´¥: æ–‡ä»¶ ${n} ä¸å­˜åœ¨`,"error"),null)}function restartServer(t){const o=serverStatus[t];if(!o)return null;if(o.currentTries>=o.maxTries)return logMessage(`æœåŠ¡å™¨ "${t}" (${o.type}) å·²è¾¾åˆ°æœ€å¤§é‡å¯æ¬¡æ•°(${o.maxTries})ï¼Œåœæ­¢å®ˆæŠ¤`,"warn"),o.keepRunning=!1,null;o.process&&o.process.kill();var e=exec("node "+o.scriptPath,{cwd:path.dirname(o.scriptPath)});return o.process=e,o.pid=e.pid,o.currentTries++,o.lastStartTime=new Date,o.lastActivity=new Date,1===o.currentTries?logMessage(`æœåŠ¡å™¨ "${t}" (${o.type}) é¦–æ¬¡å¯åŠ¨ (å°è¯•: ${o.currentTries}/${o.maxTries})`):logMessage(`æœåŠ¡å™¨ "${t}" (${o.type}) é‡å¯ (å°è¯•: ${o.currentTries}/${o.maxTries})`),o.logOutput&&(e.stdout.on("data",e=>{o.lastActivity=new Date,e.toString().trim().split("\n").forEach(e=>{e.trim()&&(e={timestamp:(new Date).toLocaleTimeString(),server:t,type:"stdout",message:e.trim()},o.logs.push(e),50<o.logs.length)&&o.logs.shift()})}),e.stderr.on("data",e=>{o.lastActivity=new Date,e.toString().trim().split("\n").forEach(e=>{var r;e.trim()&&(r=`
[${(new Date).toLocaleTimeString()}] [${t}] ERROR: `+e.trim(),e={timestamp:(new Date).toLocaleTimeString(),server:t,type:"stderr",message:e.trim()},o.logs.push(e),50<o.logs.length&&o.logs.shift(),colorLog(r,"red"))})})),e.on("close",e=>{var r=0===e?"info":"error";logMessage(`æœåŠ¡å™¨ "${t}" (${o.type}) å´©æºƒé€€å‡º (é€€å‡ºä»£ç : ${e})`,r),o.pid=null,o.process=null,o.keepRunning&&o.currentTries<o.maxTries&&(logMessage(`å°†åœ¨5ç§’åé‡å¯æœåŠ¡å™¨ "${t}" (${o.type})...`,"warn"),setTimeout(()=>restartServer(t),5e3))}),e}function showCountdown(o){return new Promise(e=>{let r=o;colorLog(`
â³ æœåŠ¡å™¨ç›‘æ§ç¨‹åºå°†åœ¨ ${r} ç§’åå¯åŠ¨...`,"yellow");const t=setInterval(()=>{r--,process.stdout.write(`\râ³ ç¨‹åºå°†åœ¨ ${r} ç§’åå¯åŠ¨...`),r<=0&&(clearInterval(t),process.stdout.write("\n\n"),e())},1e3)})}async function main(){colorLog("ğŸš€ å¯åŠ¨æœåŠ¡å™¨ç›‘æ§ç³»ç»Ÿ...","green"),colorLog(`â„¹ï¸ ç¨‹åºå°†å»¶è¿Ÿ ${START_DELAY/1e3} ç§’åæ‰§è¡Œï¼Œä»¥ä¾¿æŸ¥çœ‹æ—¥å¿—...`,"yellow"),await showCountdown(START_DELAY/1e3),colorLog("ğŸ”› æœåŠ¡å™¨ç›‘æ§ç¨‹åºå·²å¯åŠ¨","green");const r=parseIniFile(CONFIG_FILE);r||(colorLog("âŒ æ— æ³•è§£ææœåŠ¡å™¨é…ç½®ï¼Œç¨‹åºé€€å‡º","red"),process.exit(1)),r.servers.forEach(e=>{e.config={...r.globalConfig,...e.config},startServer(e)}),logMessage(`æˆåŠŸå¯åŠ¨ ${Object.keys(serverStatus).length} ä¸ªæœåŠ¡å™¨`),displayServerStatus(),process.on("SIGINT",()=>{colorLog("\nğŸ›‘ æ”¶åˆ°é€€å‡ºä¿¡å·ï¼Œæ­£åœ¨å…³é—­æ‰€æœ‰æœåŠ¡å™¨...","yellow"),Object.values(serverStatus).forEach(e=>{e.process&&e.process.kill()}),setTimeout(()=>{colorLog("âœ… æ‰€æœ‰æœåŠ¡å™¨å·²å…³é—­ï¼Œç¨‹åºé€€å‡º","green"),process.exit(0)},1e3)}),process.on("SIGTERM",()=>{process.emit("SIGINT")})}main();